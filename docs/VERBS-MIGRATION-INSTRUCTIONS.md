# Миграция глаголов для всех пользователей

## Описание
Эта миграция копирует все глаголы пользователя `cac55133-1b29-46b8-bd86-eac548c60e1c` всем остальным пользователям в системе.

## Структура базы данных
- Таблица `profiles` не содержит колонку `user_id`
- Колонка `profiles.id` является внешним ключом к `auth.users.id`
- Связь: `profiles.id = auth.users.id`

## Файлы миграции

1. **`check-verbs-migration.sql`** - Скрипт для проверки данных перед миграцией
2. **`copy-verbs-to-all-users.sql`** - Основная миграция

## Порядок выполнения

### 1. Проверка данных (ОБЯЗАТЕЛЬНО)
Сначала выполните скрипт проверки:

```sql
-- Выполните в Supabase SQL Editor
\i check-verbs-migration.sql
```

Этот скрипт покажет:
- Существует ли исходный пользователь
- Сколько глаголов у исходного пользователя
- Список глаголов для копирования
- Количество целевых пользователей
- Список целевых пользователей
- У каких пользователей уже есть глаголы

### 2. Выполнение миграции
Если проверка прошла успешно, выполните основную миграцию:

```sql
-- Выполните в Supabase SQL Editor
\i copy-verbs-to-all-users.sql
```

## Что делает миграция

1. **Проверяет безопасность**:
   - Существование исходного пользователя
   - Наличие глаголов для копирования
   - Выполняется в транзакции (можно откатить)

2. **Копирует глаголы**:
   - Всем пользователям с профилями (кроме исходного)
   - Только те глаголы, которых еще нет у пользователя
   - С новыми timestamps (created_at, updated_at)

3. **Предотвращает дубликаты**:
   - Проверяет существование глагола по infinitive
   - Не копирует уже существующие глаголы

4. **Выводит статистику**:
   - Количество целевых пользователей
   - Количество скопированных глаголов

## Безопасность

- Миграция выполняется в транзакции
- При ошибке все изменения откатываются
- Проверяется существование данных перед копированием
- Предотвращается создание дубликатов

## Откат изменений

Если нужно откатить изменения, выполните:

```sql
-- Удалить все глаголы, созданные в последнюю минуту
DELETE FROM verbs 
WHERE created_at >= NOW() - INTERVAL '1 minute'
  AND user_id != 'cac55133-1b29-46b8-bd86-eac548c60e1c';
```

## Проверка результата

После выполнения миграции проверьте результат:

```sql
-- Проверить количество глаголов у всех пользователей
SELECT 
    p.first_name,
    p.last_name,
    COUNT(v.id) as verbs_count
FROM profiles p
LEFT JOIN verbs v ON p.id = v.user_id
GROUP BY p.id, p.first_name, p.last_name
ORDER BY verbs_count DESC;
```

## Важные замечания

1. **Сделайте бэкап** перед выполнением миграции
2. **Сначала выполните проверку** - это поможет избежать ошибок
3. **Проверьте результат** после выполнения
4. Миграция затрагивает только пользователей с существующими профилями
5. Глаголы копируются с состоянием `learned = false` (не изучены)
6. Используется правильная связь: `profiles.id = auth.users.id` 